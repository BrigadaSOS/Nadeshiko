openapi: 3.1.0
info:
  title: Nadeshiko API
  description: |
    Welcome to the Nadeshiko API.

    ## Getting Started

    Nadeshiko uses API keys to grant access to the API. Authentication is performed using the Authorization header. Please note that you must be registered on Nadeshiko to generate an API key. If you haven't registered yet, please do so.

    If you haven't generated an API key yet, you can do so on your [account page](https://nadeshiko.co/settings/api), API section.

    ### Quotas and Limits
    The API has a rate limit to ensure fair usage. Each API key is subject to a rate limit of 2000 requests per 5 minutes. Exceeding this limit will result in a temporary block with the following message:
    > "Too many requests. Please try again later."

    Additionally, each account has a monthly quota limit based on the user's roles. Once the monthly quota is exceeded, the API key will be temporarily disabled for the rest of the month, and any further requests will receive the message:
    > "API Key quota exceeded for this month."

    | Role         | Quota (Monthly) |
    |--------------|-----------------|
    | Normal User  | 5000 requests   |

    To increase your quota, please contact the Nadeshiko team. For more information, refer to the [contact page](https://nadeshiko.co/about).

  version: 1.0.0
  contact:
    name: Nadeshiko Team
    url: https://nadeshiko.co

servers:
  - description: Local server
    url: http://localhost:5000/api
  - description: Production server
    url: https://api.brigadasos.xyz/api

security:
  - apiKeyHeader: []
  - jwtCookie: []

tags:
  - name: Search
    description: |
      Search endpoints for querying Japanese sentences across indexed media (anime, J-Drama, audiobooks).

      ## Authentication & Permissions

      All search endpoints require:

      | Requirement | Value |
      |-------------|-------|
      | **Authentication** | API Key via `X-API-Key` header (or SSR requests from allowed URLs) |
      | **Permission** | `READ_MEDIA` - The API key must have this permission |
      | **Rate Limit** | 2000 requests per 5 minutes (per IP address) |
      | **Monthly Quota** | Role-based (e.g., 5000 requests/month for Normal Users) |

      ## Error Codes

      - `401 Unauthorized` - Missing, invalid, or inactive API key
      - `403 Forbidden` - API key lacks `READ_MEDIA` permission
      - `429 Too Many Requests` - Rate limit or monthly quota exceeded

      ## Search Features

      - **Multi-language Support:** Search using Japanese (kanji/kana), Romaji, or English/Spanish
      - **Boolean Operators:** `AND`, `OR`, `NOT` supported
      - **Phrase Matching:** Use quotes for exact phrases (e.g., `"good morning"`)
      - **Wildcards:** `te*t` format (leading wildcards not supported)
      - **Smart Field Selection:** Automatically chooses optimal search fields based on input type
  - name: User
    description: User management and API key operations
    x-internal: true
  - name: Auth
    description: Public authentication endpoints (login, registration, OAuth...)
    x-internal: true
  - name: AuthJwt
    description: JWT-protected authentication endpoints
    x-internal: true
  - name: Admin
    description: Internal endpoints for database management
    x-internal: true
paths:
  # Search endpoints
  "/v1/search/health":
    $ref: "./paths/v1_search_health.yaml"
  "/v1/search/media/sentence":
    $ref: "./paths/v1_search_media_sentence.yaml"
  "/v1/search/media/match/words":
    $ref: "./paths/v1_search_media_match_words.yaml"
  "/v1/search/media/context":
    $ref: "./paths/v1_search_media_context.yaml"
  "/v1/search/media/info":
    $ref: "./paths/v1_search_media_info.yaml"

  # Auth endpoints
  "/v1/auth/discord/url":
    $ref: "./paths/auth/v1_auth_discord_url.yaml"
  "/v1/auth/discord":
    $ref: "./paths/auth/v1_auth_discord.yaml"
  "/v1/auth/google":
    $ref: "./paths/auth/v1_auth_google.yaml"
  "/v1/auth/login":
    $ref: "./paths/auth/v1_auth_login.yaml"
  "/v1/auth/register":
    $ref: "./paths/auth/v1_auth_register.yaml"
  "/v1/auth/logout":
    $ref: "./paths/auth-jwt/v1_auth_logout.yaml"

  # User endpoints
  "/v1/jwt/user/info":
    $ref: "./paths/user/v1_jwt_user_info.yaml"
  "/v1/auth/identity/me":
    $ref: "./paths/user/v1_auth_identity_me.yaml"
  "/v1/user/createApiKey":
    $ref: "./paths/user/v1_user_createApiKey.yaml"
  "/v1/user/getApiKeys":
    $ref: "./paths/user/v1_user_getApiKeys.yaml"
  "/v1/user/deactivateApiKey":
    $ref: "./paths/user/v1_user_deactivateApiKey.yaml"

  # Admin endpoints
  "/v1/admin/database/sync/full":
    $ref: "./paths/admin/v1_admin_database_sync_full.yaml"
  "/v1/admin/database/sync/partial":
    $ref: "./paths/admin/v1_admin_database_sync_partial.yaml"
  "/v1/admin/database/reindex/segment/{segmentId}":
    $ref: "./paths/admin/v1_admin_reindex_segment.yaml"
  "/v1/admin/database/reindex/media/{mediaId}/segments":
    $ref: "./paths/admin/v1_admin_reindex_media_segments.yaml"
  "/v1/admin/database/reindex/database":
    $ref: "./paths/admin/v1_admin_reindex_database.yaml"
  "/v1/admin/database/reindex/status":
    $ref: "./paths/admin/v1_admin_reindex_status.yaml"
  "/v1/management/media/sync/media":
    $ref: "./paths/admin/v1_management_media_sync.yaml"

components:
  securitySchemes:
    apiKeyHeader:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key authentication via X-API-Key header

    jwtCookie:
      type: apiKey
      in: cookie
      name: access_token
      description: JWT authentication via access_token cookie
