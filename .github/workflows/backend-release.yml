name: Backend Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install backend dependencies
        run: |
          cd backend
          bun install --frozen-lockfile

      - name: Install frontend dependencies
        run: |
          cd frontend
          bun install --frozen-lockfile

      - name: Validate release tag and version consistency
        env:
          RELEASE_TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          VERSION="${RELEASE_TAG#v}"

          if ! [[ "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid semver tag: ${RELEASE_TAG}"
            exit 1
          fi

          bun run release:check-version "${VERSION}"

      - name: Generate OpenAPI spec for release
        run: |
          cd backend
          bun run docs:bundle
          test -f docs/generated/openapi.yaml

      - name: Create or update GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Backend ${{ github.ref_name }}
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            backend/docs/generated/openapi.yaml

      - name: Trigger SDK release workflow
        env:
          GH_TOKEN: ${{ secrets.SDK_REPO_DISPATCH_TOKEN }}
          RELEASE_TAG: ${{ github.ref_name }}
          BACKEND_REPO: ${{ github.repository }}
          BACKEND_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "SDK_REPO_DISPATCH_TOKEN is required to dispatch SDK release workflow."
            exit 1
          fi

          VERSION="${RELEASE_TAG#v}"
          PRERELEASE="false"
          if [[ "${RELEASE_TAG}" == *"-"* ]]; then
            PRERELEASE="true"
          fi

          # Temporary source: main-v2 branch OpenAPI spec.
          SPEC_URL="https://raw.githubusercontent.com/BrigadaSOS/Nadeshiko/main-v2/backend/docs/generated/openapi.yaml"

          PAYLOAD=$(printf '{"event_type":"backend_release","client_payload":{"version":"%s","release_tag":"%s","prerelease":%s,"spec_url":"%s","backend_sha":"%s","backend_repo":"%s"}}' "${VERSION}" "${RELEASE_TAG}" "${PRERELEASE}" "${SPEC_URL}" "${BACKEND_SHA}" "${BACKEND_REPO}")

          curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            https://api.github.com/repos/BrigadaSOS/nadeshiko-sdk-ts/dispatches \
            -d "${PAYLOAD}"
